// Fast Lane Fuel Dispenser - RFID (RC522) + Relay + Web Dashboard
// Backend Integration + Manual UID Entry + Enhanced UI + Frontend Login

#include <WiFi.h>
#include <WebServer.h>
#include <HTTPClient.h>
#include <SPI.h>
#include <MFRC522.h>
#include <ArduinoJson.h>

// ====== CONFIG ======
const char* WIFI_SSID = "YourWiFiSSID";
const char* WIFI_PASSWORD = "YourWiFiPassword";
const char* BASE_URL = "http://192.168.1.100:3000";  // Backend API URL

const int RST_PIN = 22; 
const int SS_PIN  = 21; 
MFRC522 mfrc522(SS_PIN, RST_PIN);

WebServer server(80);

const int RELAY_PIN = 25;
const bool RELAY_ACTIVE_LOW = false; // Transistor inverts logic

const float PETROL_RATE_RUPEES_PER_LITRE = 100.0;
const float SECONDS_PER_LITRE = 15.0;

// STATE
String lastUID = "";
String userName = "Unknown";
float lastBalance = 0.0;
bool motorRunning = false;
unsigned long motorEndMillis = 0;
float pendingDispenseAmount = 0.0;
String dispensingUID = "";
String lastMessage = "Ready";

// Convert RFID UID to String
String uidToString(MFRC522::Uid &uid) {
  String s = "";
  for (byte i = 0; i < uid.size; i++) {
    if (uid.uidByte[i] < 0x10) s += "0";
    s += String(uid.uidByte[i], HEX);
  }
  s.toUpperCase();
  return s;
}

void relayWrite(bool on) {
  if (RELAY_ACTIVE_LOW) digitalWrite(RELAY_PIN, on ? LOW : HIGH);
  else digitalWrite(RELAY_PIN, on ? HIGH : LOW);
  relayEnabled = on;
  Serial.printf("Relay power route: %s\n", on ? "CONNECTED" : "DISCONNECTED");
}

String balanceKeyForUID(const String &uid) { return "B_" + uid; }

float getBalanceForUID(const String &uid) {
  if (uid.length() == 0) return 0.0;
  return prefs.getString(balanceKeyForUID(uid).c_str(), "0").toFloat();
}

void setBalanceForUID(const String &uid, float amount) {
  if (uid.length() == 0) return;
  prefs.putString(balanceKeyForUID(uid).c_str(), String(amount, 2));
}

// ========= ENHANCED UI WITH LOGIN =========
const char indexPage[] PROGMEM = R"rawliteral(
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fuel Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial; background:#eef2f7; margin:0; padding:20px; }

    .container { max-width: 750px; margin:auto; }

    .card {
      background:white;
      padding:25px;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(0,0,0,0.1);
      margin-bottom:20px;
    }

    input,button {
      padding:10px;
      margin:6px 0;
      font-size:16px;
      border-radius:6px;
      border:1px solid #ccc;
      width:60%;
    }

    button {
      background:#007bff;
      color:white;
      border:none;
      cursor:pointer;
      width:auto;
      padding:10px 18px;
      font-weight:bold;
    }

    button:hover { background:#0056c5; }
    
    button.stop-btn {
      background:#dc3545;
    }
    
    button.stop-btn:hover {
      background:#c82333;
    }

    .label-title {
      font-weight:bold;
      margin-top:15px;
      font-size:17px;
    }

    .title {
      font-size:28px;
      font-weight:bold;
      margin-bottom:20px;
      text-align:center;
    }

    .status-box {
      background:#f7f7f7;
      padding:15px;
      border-radius:10px;
      margin-top:15px;
    }
    
    .relay-status {
      padding:10px;
      border-radius:8px;
      margin:10px 0;
      font-weight:bold;
      text-align:center;
    }
    
    .relay-on {
      background:#d4edda;
      color:#155724;
      border:2px solid #28a745;
    }
    
    .relay-off {
      background:#f8d7da;
      color:#721c24;
      border:2px solid #dc3545;
    }

    /* LOGIN MODAL */
    #loginModal {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
    }

    #loginBox {
      background:white;
      padding:25px;
      border-radius:12px;
      width:300px;
      box-shadow:0 3px 10px rgba(0,0,0,0.2);
      animation:pop 0.2s ease;
    }

    @keyframes pop {
      from { transform:scale(0.8); opacity:0; }
      to   { transform:scale(1); opacity:1; }
    }

  </style>
</head>

<body>
<div class="container">

  <div class="title">‚õΩ ESP32 Fuel Dispenser</div>

  <div class="card">
    <div><strong>Last scanned UID:</strong> <span id="uid">-</span></div>

    <!-- MANUAL UID ENTRY -->
    <div class="label-title">Manual UID Entry</div>
    <input id="manualuid" type="text" placeholder="Enter UID (HEX)" disabled>
    <button onclick="openLogin()">Unlock</button>
    <button onclick="setUID()">Set UID</button>

    <div style="margin-top:10px;">
      <strong>Balance (‚Çπ):</strong> <span id="balance">-</span>
    </div>

    <hr/>

    <div class="label-title">Top-up Amount (‚Çπ)</div>
    <input id="topup" type="number" step="0.01" placeholder="Enter amount">
    <button onclick="addBalance()">Add Balance</button>

    <hr/>

    <div class="label-title">Amount to Dispense (‚Çπ)</div>
    <input id="amount" type="number" step="0.01" placeholder="e.g. 100">
    <button onclick="startDispense()">Start Dispensing</button>
    <button class="stop-btn" onclick="stopDispense()">Stop/Emergency</button>

    <div class="status-box">
      <div id="relayStatus" class="relay-status relay-off">‚ö†Ô∏è RELAY: DISCONNECTED</div>
      <div><strong>Motor Status:</strong> <span id="motor">OFF</span></div>
      <div><strong>Message:</strong> <span id="msg">Waiting for card scan...</span></div>
      <div><strong>Time Remaining:</strong> <span id="timeLeft">-</span></div>
    </div>

  </div>

</div>

<!-- LOGIN MODAL -->
<div id="loginModal">
  <div id="loginBox">
    <h3 style="text-align:center;">üîê Login</h3>
    <input id="loginUser" type="text" placeholder="Username" style="width:100%;">
    <input id="loginPass" type="password" placeholder="Password" style="width:100%;">
    <button style="width:100%; margin-top:10px;" onclick="checkLogin()">Login</button>
    <button style="width:100%; margin-top:10px; background:#555;" onclick="closeLogin()">Cancel</button>
  </div>
</div>

<script>

let loginOK = false;

// OPEN LOGIN POPUP
function openLogin(){
  document.getElementById('loginModal').style.display = "flex";
}

// CLOSE LOGIN POPUP
function closeLogin(){
  document.getElementById('loginModal').style.display = "none";
}

// LOGIN CHECK
function checkLogin(){
  let u = document.getElementById('loginUser').value;
  let p = document.getElementById('loginPass').value;

  if(u === "user2025" && p === "user2025"){
    loginOK = true;
    document.getElementById('manualuid').disabled = false;
    alert("‚úÖ Unlocked!");
    closeLogin();
  } else {
    alert("‚ùå Incorrect ID or Password!");
  }
}

// SEND UID TO ESP32
async function setUID(){
  if(!loginOK){
    alert("Please login to unlock manual entry.");
    return;
  }

  const uid = document.getElementById('manualuid').value.trim();
  if(!uid){ alert("Enter UID"); return; }

  let res = await fetch("/setuid", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({uid:uid})
  });

  let j = await res.json();
  alert(j.msg);
  fetchStatus();
}

// FETCH STATUS
async function fetchStatus(){
  try {
    let res = await fetch('/status');
    let j = await res.json();

    document.getElementById('uid').innerText = j.uid || '-';
    document.getElementById('balance').innerText = '‚Çπ' + j.balance.toFixed(2);
    
    // Update relay status
    let relayDiv = document.getElementById('relayStatus');
    if(j.relayEnabled) {
      relayDiv.className = 'relay-status relay-on';
      relayDiv.innerHTML = '‚úÖ RELAY: POWER CONNECTED';
    } else {
      relayDiv.className = 'relay-status relay-off';
      relayDiv.innerHTML = '‚ö†Ô∏è RELAY: DISCONNECTED';
    }
    
    // Update motor status
    if(j.motorRunning) {
      document.getElementById('motor').innerText = 'RUNNING';
      document.getElementById('timeLeft').innerText = j.secondsRemaining.toFixed(1) + 's';
    } else {
      document.getElementById('motor').innerText = 'OFF';
      document.getElementById('timeLeft').innerText = '-';
    }
    
    document.getElementById('msg').innerText = j.message;
  } catch(e) {
    console.error('Status fetch error:', e);
  }
}

// START DISPENSE
async function startDispense(){
  const amount = parseFloat(document.getElementById('amount').value || 0);
  if(amount<=0){ alert("Enter valid amount"); return; }

  let res = await fetch("/start", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({amount})
  });

  let j = await res.json();
  alert(j.msg);
  fetchStatus();
}

// STOP DISPENSE (EMERGENCY)
async function stopDispense(){
  if(!confirm("Stop dispensing immediately?")) return;
  
  let res = await fetch("/stop", {
    method:"POST"
  });

  let j = await res.json();
  alert(j.msg);
  fetchStatus();
}

// TOPUP
async function addBalance(){
  const amount = parseFloat(document.getElementById('topup').value || 0);
  if(amount<=0){ alert("Enter valid amount"); return; }

  let res = await fetch("/topup", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({amount})
  });

  let j = await res.json();
  alert(j.msg);
  fetchStatus();
}

setInterval(fetchStatus, 1000);
fetchStatus();

</script>

</body>
</html>
)rawliteral";

// ========= BACKEND HANDLERS =========

// Manual UID handler
void handleSetUID() {
  String body = server.arg("plain");
  StaticJsonDocument<256> doc;
  DeserializationError err = deserializeJson(doc, body);
  
  if (err) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Invalid JSON\"}");
    return;
  }

  String uid = doc["uid"] | "";
  if (uid.length() == 0) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Invalid UID\"}");
    return;
  }

  uid.toUpperCase();
  lastUID = uid;
  lastBalance = getBalanceForUID(uid);

  Serial.printf("Manual UID set: %s, Balance: %.2f\n", uid.c_str(), lastBalance);
  server.send(200, "application/json", "{\"ok\":true,\"msg\":\"UID set manually\"}");
}

// ROOT PAGE
void handleRoot() {
  server.send_P(200, "text/html", indexPage);
}

// STOP DISPENSING (EMERGENCY)
void handleStop() {
  if (!motorRunning) {
    server.send(200, "application/json", "{\"ok\":true,\"msg\":\"Motor not running\"}");
    return;
  }

  // Turn off relay immediately
  relayWrite(false);
  motorRunning = false;

  // Calculate partial dispense
  unsigned long elapsedMs = millis() - (motorEndMillis - (unsigned long)(pendingDispenseAmount / PETROL_RATE_RUPEES_PER_LITRE * SECONDS_PER_LITRE * 1000));
  float elapsedSec = elapsedMs / 1000.0;
  float dispensedLiters = elapsedSec / SECONDS_PER_LITRE;
  float dispensedAmount = dispensedLiters * PETROL_RATE_RUPEES_PER_LITRE;

  // Deduct only dispensed amount
  float bal = getBalanceForUID(dispensingUID);
  bal -= dispensedAmount;
  if (bal < 0) bal = 0;

  setBalanceForUID(dispensingUID, bal);
  if (dispensingUID == lastUID) lastBalance = bal;

  Serial.printf("Emergency stop! Dispensed: %.2f rupees, New balance: %.2f\n", dispensedAmount, bal);

  pendingDispenseAmount = 0;
  dispensingUID = "";

  server.send(200, "application/json", "{\"ok\":true,\"msg\":\"Stopped! Partial amount deducted\"}");
}

// TOP-UP BALANCE
void handleTopup() {
  String body = server.arg("plain");
  StaticJsonDocument<256> doc;
  DeserializationError err = deserializeJson(doc, body);
  
  if (err) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Invalid JSON\"}");
    return;
  }

  float amount = doc["amount"] | 0.0f;

  if (lastUID.length() == 0) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"No card/UID set. Scan card first!\"}");
    return;
  }

  if (amount <= 0) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Invalid amount\"}");
    return;
  }

  float bal = getBalanceForUID(lastUID);
  bal += amount;
  setBalanceForUID(lastUID, bal);
  lastBalance = bal;

  Serial.printf("üí∞ Top-up: ‚Çπ%.2f added to %s | New balance: ‚Çπ%.2f\n", amount, lastUID.c_str(), bal);

  String json = "{\"ok\":true,\"msg\":\"Balance updated\",\"newBalance\":" + String(bal, 2) + "}";
  server.send(200, "application/json", json);
}

// STATUS (UPDATED)
void handleStatus() {
  float sec = motorRunning ? (float)(motorEndMillis - millis()) / 1000.0 : 0;
  if (sec < 0) sec = 0;

  String json = "{";
  json += "\"uid\":\"" + lastUID + "\",";
  json += "\"balance\":" + String(lastBalance, 2) + ",";
  json += "\"motorRunning\":" + String(motorRunning ? "true" : "false") + ",";
  json += "\"relayEnabled\":" + String(relayEnabled ? "true" : "false") + ",";
  json += "\"secondsRemaining\":" + String(sec) + ",";
  json += "\"message\":\"" + String(motorRunning ? "Dispensing fuel..." : "Ready for card scan") + "\"";
  json += "}";

  server.send(200, "application/json", json);
}

// START DISPENSING (UPDATED)
void handleStart() {
  String body = server.arg("plain");
  StaticJsonDocument<256> doc;
  DeserializationError err = deserializeJson(doc, body);
  
  if (err) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Invalid JSON\"}");
    return;
  }

  float amount = doc["amount"] | 0.0f;

  if (lastUID.length() == 0) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"No card/UID set. Scan card first!\"}");
    return;
  }

  if (motorRunning) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Already dispensing!\"}");
    return;
  }

  float bal = getBalanceForUID(lastUID);
  if (bal < amount) {
    server.send(400, "application/json", "{\"ok\":false,\"msg\":\"Insufficient balance: ‚Çπ\" + String(bal,2)}");
    return;
  }

  float liters = amount / PETROL_RATE_RUPEES_PER_LITRE;
  float sec = liters * SECONDS_PER_LITRE;

  // CONNECT RELAY POWER ROUTE
  relayWrite(true);
  
  motorRunning = true;
  pendingDispenseAmount = amount;
  dispensingUID = lastUID;
  motorEndMillis = millis() + (unsigned long)(sec * 1000);

  Serial.printf("‚úÖ Relay power route CONNECTED\n");
  Serial.printf("Dispensing: ‚Çπ%.2f (%.2fL) for %s - Duration: %.1fs\n", 
                amount, liters, lastUID.c_str(), sec);
  
  server.send(200, "application/json", "{\"ok\":true,\"msg\":\"Power route connected! Press physical START button on pump\"}");
}

// ========= SETUP =========
void setup() {
  Serial.begin(115200);
  delay(500);
  Serial.println("\n\n=== ESP32 Fuel Dispenser ===");
  
  SPI.begin();
  mfrc522.PCD_Init();
  Serial.println("‚úÖ MFRC522 RFID reader initialized");

  pinMode(RELAY_PIN, OUTPUT);
  relayWrite(false);  // Start with relay DISCONNECTED
  Serial.println("‚úÖ Relay initialized (Power route: DISCONNECTED)");
  
  // Initialize start button (optional physical button)
  pinMode(START_BUTTON_PIN, INPUT_PULLUP);
  Serial.println("‚úÖ Start button initialized");

  prefs.begin("balances", false);
  Serial.println("‚úÖ Preferences storage initialized");

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi: ");
  Serial.println(WIFI_SSID);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ WiFi connected!");
    Serial.print("üì° IP address: ");
    Serial.println(WiFi.localIP());
    Serial.print("üåê Dashboard: http://");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\n‚ùå WiFi connection failed!");
  }

  server.on("/", handleRoot);
  server.on("/status", handleStatus);
  server.on("/setuid", HTTP_POST, handleSetUID);
  server.on("/start", HTTP_POST, handleStart);
  server.on("/stop", HTTP_POST, handleStop);  // NEW: Stop endpoint
  server.on("/topup", HTTP_POST, handleTopup);

  server.begin();
  Serial.println("‚úÖ Web server started");
  Serial.println("\nüöÄ System ready!");
  Serial.println("üîê Login: user2025 / user2025");
  Serial.println("\nüìå RELAY LOGIC:");
  Serial.println("   - Relay OFF = Power route DISCONNECTED (motor can't start)");
  Serial.println("   - Relay ON  = Power route CONNECTED (press physical START button)");
}

// ========= LOOP =========
void loop() {
  server.handleClient();

  // Check for RFID card
  if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {
    lastUID = uidToString(mfrc522.uid);
    lastBalance = getBalanceForUID(lastUID);
    Serial.printf("üí≥ Card detected: %s | Balance: ‚Çπ%.2f\n", lastUID.c_str(), lastBalance);
    mfrc522.PICC_HaltA();
  }

  // Check if dispensing time is complete
  if (motorRunning && millis() >= motorEndMillis) {
    // DISCONNECT RELAY POWER ROUTE
    relayWrite(false);
    motorRunning = false;

    // Deduct full amount
    float bal = getBalanceForUID(dispensingUID);
    bal -= pendingDispenseAmount;
    if (bal < 0) bal = 0;

    setBalanceForUID(dispensingUID, bal);
    if (dispensingUID == lastUID) lastBalance = bal;

    Serial.printf("‚úÖ Dispensing complete | Amount: ‚Çπ%.2f | New balance: ‚Çπ%.2f\n", 
                  pendingDispenseAmount, bal);
    Serial.println("‚ö†Ô∏è Relay power route DISCONNECTED");

    pendingDispenseAmount = 0;
    dispensingUID = "";
  }
  
  // Optional: Physical start button monitoring
  // (Can be used to manually trigger dispensing if needed)
  static unsigned long lastButtonCheck = 0;
  if (millis() - lastButtonCheck > 100) {
    if (digitalRead(START_BUTTON_PIN) == LOW && relayEnabled && !motorRunning) {
      Serial.println("üîò Physical START button pressed!");
      // You can add additional logic here if needed
    }
    lastButtonCheck = millis();
  }
}
